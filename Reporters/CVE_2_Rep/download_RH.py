import requests
import json

# Load all cve ids
with open("./../../Mappings/Project_2_CVE/project2cves.json") as jf:
    project2cves = json.load(jf)

cve_list = []
for project in ['mozilla-suite', 'apache', 'linux', 'php']:
    cve_list.extend(project2cves[project])

cve_list = list(set(cve_list))

# Find already fetched RH BTSs
try:
    with open("./rh2info.json") as jf:
        rh_bugs = json.load(jf)
    print("Opened all already downloaded RH BTS bugs!")
    print(list(rh_bugs.keys()))
except:
    rh_bugs = dict()
    print("No local RH BTS bugs found!")

# Download RH BTSs
i=0
for cve in cve_list:
    if cve not in rh_bugs:
        response = requests.get('https://bugzilla.redhat.com/rest/bug/'+cve+'?include_fields=summary,status,resolution,comments')
        if(response.ok):
            rh = json.loads(response.content)
            rh_bugs[cve] = rh
            i+=1
            #print(i)
        else:
            print('Trouble getting page for ', cve)

with open("./rh_bugs.json", "w") as jf:
    json.dump(rh_bugs, jf)

print("Finished!")