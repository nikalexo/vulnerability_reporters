"""
Stores reporters in mongodb databases.
"""

import traceback
import sys
import pprint
import json
import os
from pymongo import MongoClient 
import xml.etree.ElementTree as ET

root = ET.parse("./../config.xml")

DB = root.find("mongodb").find("db").text

PROJECT = ""
# Set folder name with bugs inside
REP2INFO = "./Rep_2_Info_5/rep2info_s4.json"
COLLECTION = root.find("reporters").find("collection").text

# Connect to Mongodb
client = MongoClient()

# Get database
db = client[DB]
print("Database: " + str(db.name.encode("utf-8")))

# Check if database already exists
dblist = client.list_database_names()
if db.name in dblist:
    print("The database already exists.")

# Create or import collection for specified project
collection = db[COLLECTION]
print("Collection: " + collection.name + "\n")

# Remove all data in collection
print("Removing all old entries in collection...", end=" ", flush=True)
collection.delete_many({})
print("Done\n")

# Load csv file with rep2info
print("Load json file with rep2info...", end=" ", flush=True)
with open(REP2INFO) as f:
    reps = json.load(f)
print("Done\n")

for rep in reps:
    # {"0x000000": {"cves": ["CVE-2008-2419"], "affs": [], "emails": [], "twitter": [], "alias": [], "misc": [], "type"},...}
    name = rep
    cves = reps[name]['cves']
    affs = reps[name]['affs']
    twitters = reps[name]['twitter']
    emails = reps[name]['emails']
    alias = reps[name]['alias']
    alias_cleaned = []
    for al in alias:
        if al != None:
            alias_cleaned.append(al)     
    type_ = reps[name]['type']
    misc = reps[name]['misc']
    
    info = dict()
    info['name'] = name
    info['cves'] = cves
    info['affiliations'] = affs
    info['twitters'] = twitters
    info['emails'] = emails
    info['aliases'] = alias_cleaned
    info['type'] = type_
    info['misc'] = misc
    
    collection.insert_one(info)
    
rep = collection.find_one({"type":"p"})
print("Example reporter in database:", rep)
print("Number of reporters in rep2info csv file:", len(reps.keys()))
print("Number of reporters in database:", collection.count_documents({}))
    