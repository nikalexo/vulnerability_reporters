import requests
import json
import sys
import time

bug_2_comments = dict()
bugs = []

with open("apache_bugs.list") as f:
    lines = f.readlines()
    for line in lines:
        bugs.append(line.strip("\n"))

print("All bugs loaded")

if len(sys.argv) > 2:
    START = int(sys.argv[1])
    END = min(int(sys.argv[2]), len(bugs))
else:
    START = 0
    END = len(bugs)

i = 0
not_fetched = []

for bug in bugs[START:END]:
    try:
        # first try requesting comments
        r = requests.get('https://bz.apache.org/bugzilla/rest.cgi/bug/' + bug + '/comment')
        if r.status_code != 200:
            print(r.status_code)
            print(r.text)   
        try:
            bug_2_comments[bug] = r.json()['bugs'][bug]['comments']
        except json.decoder.JSONDecodeError:
            try:
                # maybe error if too many request -> wait 1 hour
                time.sleep(300)
                # second try requesting comments
                r = requests.get('https://bz.apache.org/bugzilla/rest.cgi/bug/' + bug + '/comment')
                if r.status_code != 200:
                    print(r.status_code)
                    print(r.text)   
                try:
                    bug_2_comments[bug] = r.json()['bugs'][bug]['comments']
                except json.decoder.JSONDecodeError:
                    print('Comments of bug ' + bug + 'could not fetched!')
                    not_fetched.append(bug)
            except:
                print('Error with request for bug: ', bug)
    except:
        print('Error with request for bug: ', bug)
    
    i += 1    
    if i%1000 == 0:
        print("Bug counter:", i)

print('Not fetched:')
print(not_fetched)
print('Try again...')

i = 0
not_fetched_again = []

for bug in not_fetched:
    try:
        r = requests.get('https://bz.apache.org/bugzilla/rest.cgi/bug/' + bug + '/comment')
        if r.status_code != 200:
            print(r.status_code)
            print(r.text)   
        try:
            bug_2_comments[bug] = r.json()['bugs'][bug]['comments']
        except json.decoder.JSONDecodeError:
            try:
                time.sleep(900)
                r = requests.get('https://bz.apache.org/bugzilla/rest.cgi/bug/' + bug + '/comment')
                if r.status_code != 200:
                    print(r.status_code)
                    print(r.text)   
                try:
                    bug_2_comments[bug] = r.json()['bugs'][bug]['comments']
                except json.decoder.JSONDecodeError:
                    print('Comments of bug ' + bug + 'could not fetched!')
                    not_fetched.append(bug)
            except:
                print('Error with request for bug: ', bug)
    except:
        print('Error with request for bug: ', bug)
    
    i += 1
    if i%1000 == 0:
        print("Bug counter:", i)

print('Not fetched again:')
print(not_fetched_again)

print("Number of bugs with fetched comments:", len(bug_2_comments))

with open('apache_comments.json', 'w') as fp:
    json.dump(bug_2_comments, fp)

print("Successfully saved comments in apache_comments.json")