import requests
import json
import sys
import time
import traceback

bug_2_comments = dict()
bugs = []

with open("linux_bugs.list") as f:
    lines = f.readlines()
    for line in lines:
        bugs.append(line.strip("\n"))

print("All bugs loaded")

if len(sys.argv) > 2:
    START = int(sys.argv[1])
    END = min(int(sys.argv[2]), len(bugs))
else:
    START = 0
    END = len(bugs)

i = 0
not_fetched = []

for bug in sorted(bugs)[START:END]:
    try:
        # first try requesting comments
        r = requests.get('https://bugzilla.kernel.org/rest/bug/' + bug + '/comment')
        if r.status_code != 200:
            print(r.status_code)
            print(r.text)   
        try:
            bug_2_comments[bug] = r.json()['bugs'][bug]['comments']
        except json.decoder.JSONDecodeError:
            try:
                r = requests.get('https://bugzilla.kernel.org/rest/bug/' + bug + '/comment')
                if r.status_code != 200:
                    print(r.status_code)
                    print(r.text)   
                try:
                    bug_2_comments[bug] = r.json()['bugs'][bug]['comments']
                except json.decoder.JSONDecodeError:
                    print('Comments of bug ' + bug + 'could not fetched!')
                    not_fetched.append(bug)
            except:
                print('Error with request for bug: ', bug)
    except:
        print('Error with request for bug: ', bug)
        traceback.print_exc()
    
    i += 1    
    if i%1000 == 0:
        print("Bug counter:", i)

print('Not fetched:')
print(not_fetched)
print('Try again...')

i = 0
not_fetched_again = []

for bug in not_fetched:
    try:
        r = requests.get('https://bugzilla.kernel.org/rest/bug/' + bug + '/comment')
        if r.status_code != 200:
            print(r.status_code)
            print(r.text)   
        try:
            bug_2_comments[bug] = r.json()['bugs'][str(bug)]['comments']
        except json.decoder.JSONDecodeError:
            try:
                #time.sleep(3600)
                r = requests.get('https://bugzilla.kernel.org/rest/bug/' + bug + '/comment')
                if r.status_code != 200:
                    print(r.status_code)
                    print(r.text)   
                try:
                    bug_2_comments[bug] = r.json()['bugs'][str(bug)]['comments']
                except json.decoder.JSONDecodeError:
                    print('Comments of bug ' + bug + 'could not fetched!')
                    not_fetched.append(bug)
            except:
                print('Error with request for bug: ', bug)
    except:
        print('Error with request for bug: ', bug)
    
    i += 1 
    if i%1000 == 0:
        print("Bug counter:", i)

print('Not fetched again:')
print(not_fetched_again)

print("Number of bugs with fetched comments:", len(bug_2_comments))

with open('linux_comments_' + str(START) + "_" + str(END) + '.json', 'w') as fp:
    json.dump(bug_2_comments, fp)

print("Successfully saved comments in linux_comments.json")