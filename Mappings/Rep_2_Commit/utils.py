from fuzzywuzzy import fuzz
import json

# Maps reporters to commits by accordance of developer and fields in reporter collection
def rep2commits(rep2commits, commits, reporters_dict):
    reporters = []
    
    for rep in reporters_dict:
        if not rep in rep2commits.keys():
            rep2commits[rep] = []
        reporters.append([rep, reporters_dict[rep]['emails'], reporters_dict[rep]['alias'], reporters_dict[rep]['twitter']])
    
    print("Number of reporters added to rep2commits:", len(rep2commits.keys()))
    
    counter = [0 for x in range(5)]
    
    for commit in commits:
        # load creator details
        developer_name = commit.author.name.lower()
        developer_email = commit.author.email.lower()
        
        found = False
        
        for rep in reporters:
            # load reporter details
            rep_name_not_changed = rep[0]
            
            rep_name = rep[0].lower()
            rep_emails = [r.lower() for r in rep[1] if r != None]
            rep_aliases = [r.lower() for r in rep[2] if r != None]
            rep_twitters = [r.lower() for r in rep[3] if r != None]
            
            
            # check if creator of commit and reporter match
            if developer_name == rep_name:
                rep2commits[rep_name_not_changed].append(commit.hexsha)
                counter[0] += 1
                found = True
                #print(developer_name)
            elif developer_email in rep_emails or developer_email == rep_name or developer_email in rep_twitters or developer_email in rep_aliases:
                rep2commits[rep_name_not_changed].append(commit.hexsha)
                counter[1] += 1
                found = True
                #print(developer_name)
            elif developer_name in rep_aliases or developer_name in rep_twitters or developer_name in rep_emails:
                rep2commits[rep_name_not_changed].append(commit.hexsha)
                counter[2] += 1
                found = True
                #print(developer_name)
            elif fuzz.ratio(developer_name, rep_name) > 90:
                rep2commits[rep_name_not_changed].append(commit.hexsha)
                counter[3] += 1
                found = True
                #print(developer_name)
            if found:
                break
         
        if not found:
            for rep in reporters:
                # load reporter details
                rep_name_not_changed = rep[0]

                rep_name = rep[0].lower()
                rep_emails = [r.lower() for r in rep[1] if r != None]
                rep_aliases = [r.lower() for r in rep[2] if r != None]
                rep_twitters = [r.lower() for r in rep[3] if r != None]
                for alias in rep_aliases:
                    if len(alias) > 5 and len(developer_name) > 5 and fuzz.ratio(developer_name, alias) > 90:
                        rep2commits[rep_name_not_changed].append(commit.hexsha)
                        counter[4] += 1
                        found = True
                        #print(developer_name)
                        break
                if found:
                    break
               
    return counter
        
def load_reporters():
    rep2info = dict()
    with open('./../../Reporters/Rep_2_Info_5/rep2info_s4.json', 'r') as fp:
        rep2info = json.load(fp)

    return rep2info