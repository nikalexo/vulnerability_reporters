import utils
import json, os
from pymongo import MongoClient
import xml.etree.ElementTree as ET

root = ET.parse("./../../config.xml")

DB = root.find("mongodb").find("db").text
COLLECTION_1 = root.find("projects").find('.//product[@name=\'mozilla-core\']').find("collection").text
COLLECTION_2 = root.find("projects").find('.//product[@name=\'firefox\']').find("collection").text

REG_EXPRS_COMMENT_2 = root.find("projects").find('.//product[@name=\'firefox\']').find("reg_exprs_bug_comment_2").text.split("\n")

REPO = "./../../../gecko-dev"

client = MongoClient()
db = client[DB]
collection_1 = db[COLLECTION_1]
collection_2 = db[COLLECTION_2]

bug_1 = collection_1.find_one()
bug_2 = collection_2.find_one()

print("Example Bugs:")
print(bug_1['id'])
print(bug_2['id'])

# check comments for mercurial revision numbers - mozilla-central
print("Starting!")
bug2revs = dict()
for expr in REG_EXPRS_COMMENT_2:
    print("Current regular expression: " + expr)
    utils.parse_comments(bug2revs, collection_1, expr)
    utils.parse_comments(bug2revs, collection_2, expr)
print("Finished parse_comments(...)")

with open("extra_core-firefox_revs.json", "w") as jf:
    json.dump(bug2revs, jf)
print("Finished!")
