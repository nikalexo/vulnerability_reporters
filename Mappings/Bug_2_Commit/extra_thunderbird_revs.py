import utils
from git import Repo
import json, os
from pymongo import MongoClient
import xml.etree.ElementTree as ET

root = ET.parse("./../../config.xml")

DB = root.find("mongodb").find("db").text
COLLECTION = root.find("projects").find('.//product[@name=\'thunderbird\']').find("collection").text

REG_EXPRS_COMMENT_2 = root.find("projects").find('.//product[@name=\'thunderbird\']').find("reg_exprs_bug_comment_2").text.split("\n")

REPO_1 = "./../../../releases-comm-central"
REPO_2 = "./../../../gecko-dev"

client = MongoClient()
db = client[DB]
collection_1 = db[COLLECTION]

bug = collection_1.find_one()

print("Example Bug:")
print(bug['id'])

# check comments for mercurial revision numbers - mozilla-central/comm-central
print("Starting!")
bug2revs_1 = dict()
bug2revs_2 = dict()
for expr in REG_EXPRS_COMMENT_2:
    print("Current regular expression: " + expr)
    if "comm-central" in expr:
        utils.parse_comments(bug2revs_1, collection_1, expr)
    elif "mozilla-central" in expr:
        utils.parse_comments(bug2revs_2, collection_1, expr)
print("Finished parse_comments(...)")

with open("extra_thunderbird_revs_comm.json", "w") as jf:
    json.dump(bug2revs_1, jf)
with open("extra_thunderbird_revs_mozilla.json", "w") as jf:
    json.dump(bug2revs_2, jf)
print("Finished!")