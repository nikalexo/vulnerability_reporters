import utils
import json, os
from pymongo import MongoClient
import xml.etree.ElementTree as ET

root = ET.parse("./../../config.xml")

DB = root.find("mongodb").find("db").text
COLLECTION = root.find("projects").find('.//product[@name=\'apache\']').find("collection").text

REG_EXPRS_COMMENT_2 = root.find("projects").find('.//product[@name=\'apache\']').find("reg_exprs_bug_comment_2").text.split("\n")

client = MongoClient()
db = client[DB]
collection = db[COLLECTION]

bug = collection.find_one()

print("Example Bug:")
print(bug['id'])

# check comments for revision numbers
print("Starting!")
bug2revs = dict()
for expr in REG_EXPRS_COMMENT_2:
    print("Current regular expression: " + expr)
    utils.parse_comments(bug2revs, collection, expr)
print("Finished parse_comments(...)")

with open("extra_apache_revs.json", "w") as jf:
    json.dump(bug2revs, jf)
print("Finished!")