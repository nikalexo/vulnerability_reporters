#!/usr/bin/env python
# coding: utf-8

# In[1]:


from git import Repo
import json
import re
import sys
from pymongo import MongoClient
import xml.etree.ElementTree as ET
import utils
import os


# In[2]:


root = ET.parse("./../../config.xml")

DB = root.find("mongodb").find("db").text
COLLECTION = root.find("projects").find('.//product[@name=\'apache\']').find("collection").text

REG_EXPRS_COMMIT = root.find("projects").find('.//product[@name=\'apache\']').find("reg_exprs_bug_commit").text.split("\n")
REG_EXPRS_COMMENT_1 = root.find("projects").find('.//product[@name=\'apache\']').find("reg_exprs_bug_comment_1").text.split("\n")
REG_EXPRS_COMMENT_2 = root.find("projects").find('.//product[@name=\'apache\']').find("reg_exprs_bug_comment_2").text.split("\n")
REPO = "./../../../httpd"

BUG_LIST_PATH = "./bugs-apache.list"


# In[3]:


client = MongoClient()
db = client[DB]
collection = db[COLLECTION]

bug = collection.find_one({})

if bug != None:
    print("Example bug:", bug['id'])
else:
    sys.exit("No bugs in database collection!")


# In[ ]:


bug2commits = dict()
bug2date = dict()


# In[ ]:


repo = Repo(REPO)
commits = list(repo.iter_commits('trunk', max_count=1000000))


# In[ ]:


# 0. Add all bug-ids of bug tracking system to dict
if not os.path.exists(BUG_LIST_PATH):
    utils.add_bugs_to_dict(bug2commits, collection)
    
    # write bug list into file for fast bug-id loading
    with open(BUG_LIST_PATH, "w") as f:
        for bug in bug2commits.keys():
            f.write(str(bug) + "\n")
else:
    # fast loading of bug-ids (only possible if bugs-[...].list already available)
    with open(BUG_LIST_PATH, "r") as f:
        lines = f.readlines()
        for bug in lines:
            bug2commits[bug[:-1]] = []
    # check if number of bugs in file is equal to the number in the database
    if len(bug2commits.keys()) != collection.count_documents({}):
        bug2commits = dict()
        utils.add_bugs_to_dict(bug2commits, collection)
        with open(BUG_LIST_PATH, "w") as f:
            for bug in bug2commits.keys():
                f.write(str(bug) + "\n")
            
utils.add_date_to_bug(bug2date, collection)
print("Number of bugs in bug2commits: " + str(len(bug2commits.keys())))
print("Number of bugs in database: " + str(collection.count_documents({})))


# In[ ]:


# 1. Check commit messages in httpd repo for mentioned bugs
updates = 0
for expr in REG_EXPRS_COMMIT:
    print("Current regular expression: " + expr)
    if "apache.org/bugzilla/" in expr:
        updates += utils.extract_bugs_commits(bug2commits, bug2date, commits, expr)
    else:
        # Min time difference between commit and bug creation time or last modification time has to be < 700 days
        updates += utils.extract_bugs_commits(bug2commits, bug2date, commits, expr, True, 700) 


# In[ ]:


utils.print_changes(bug2commits, updates)


# In[ ]:


# 2. check comments in bugs for custom urls like github
for expr in REG_EXPRS_COMMENT_1:
    print("Current regular expression: " + expr)
    updates = utils.parse_comments(bug2commits, collection, expr, True)


# In[ ]:


utils.print_changes(bug2commits, updates)


# In[ ]:


# 3. check comments for revision numbers
with open("extra_apache.json") as jf:
    bug2commits_temp = json.load(jf)
updates = utils.insert_extra(bug2commits, bug2commits_temp)


# In[ ]:


utils.print_changes(bug2commits, updates)


# In[ ]:


client.close()
with open('bug2commits-apache.json', 'w') as fp:
    json.dump(bug2commits, fp)


# In[ ]:




