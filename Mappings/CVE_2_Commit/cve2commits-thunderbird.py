#!/usr/bin/env python
# coding: utf-8

# In[1]:


import os
import re
import sys
import json
from git import Repo
from pymongo import MongoClient
import xml.etree.ElementTree as ET
import utils


# In[2]:


# insert at 1, 0 is the script path (or '' in REPL)
sys.path.insert(1, '../../../cve-search/')

import lib.DatabaseLayer as db


# In[3]:


root = ET.parse("./../../config.xml")
client = MongoClient()

DB = root.find("mongodb").find("db").text

path_cve2bugs = "./../CVE_2_Bug/cve2bugs-thunderbird.json"
path_bug2commits = "./../Bug_2_Commit/bug2commits-thunderbird.json"

path_bug2commits_ff = "./../Bug_2_Commit/bug2commits-core-firefox.json"

REG_EXPRS = root.find("projects").find('.//product[@name=\'thunderbird\']').find("reg_exprs_bug_comment_1").text.split("\n")

REPO_1 = "../../../releases-comm-central"
REPO_2 = "../../../gecko-dev"


# In[4]:


cve2commits = dict()


# In[5]:


# 1.1. CVE -> Bug -> Commit: Thunderbird
print("Map cves to commits by cve to bug and bug to commit...")
with open(path_cve2bugs) as jf:
    cve2bugs = json.load(jf)
with open(path_bug2commits) as jf:
    bug2commits = json.load(jf)

utils.cve_bug_commit(cve2bugs, bug2commits, cve2commits)


# In[6]:


utils.print_changes(cve2commits, None)


# In[7]:


# 1.2. CVE -> Bug -> Commit: Thunderbird cve2bugs + Core/Firefox bugs2commit
print("Map cves to commits by cve to bug and bug to commit...")
with open(path_bug2commits_ff) as jf:
    bug2commits_ff = json.load(jf)

utils.cve_bug_commit(cve2bugs, bug2commits_ff, cve2commits)


# In[8]:


utils.print_changes(cve2commits, None)


# In[9]:


# 2.1. Check commit messages in releases-comm-central repo
print("Check commit messages in releases-comm-central repo for cves...")
repo = Repo(REPO_1)
commits = list(repo.iter_commits('master', max_count=1000000))

updates = utils.extract_cves_commits(cve2commits, commits, False)


# In[10]:


utils.print_changes(cve2commits, updates)


# In[11]:


# 2.2. Check commit messages in gecko-dev repo
print("Check commit messages in gecko-dev repo for cves...")
repo = Repo(REPO_2)
commits = list(repo.iter_commits('master', max_count=1000000))

updates = utils.extract_cves_commits(cve2commits, commits, False)


# In[12]:


utils.print_changes(cve2commits, updates)


# In[13]:


# 3. Extract references to commit in cves using cve-search
print("Extract references to commit in cves using cve-search...")

# load all cves which are relevant for the project
with open("./../Project_2_CVE/project2cves.json") as jf:
    project2cves = json.load(jf)
    cves = project2cves["thunderbird"]
print("Number of found cves in cve-search:", len(cves))

# load all cves with content
db_cves = client["cvedb"]
coll_cves = db_cves.cves
cve2bugs = dict()
cve_list = []
for cve in cves:
    cve2bugs[cve] = []
    full_cve = coll_cves.find_one({'id':cve})
    if full_cve != None:
        cve_list.append(full_cve)
print("Number of found cves in cve-search:", len(cve_list))

updates = utils.extract_commits_cve_refernces(cve2commits, cve_list, REG_EXPRS, False)


# In[14]:


utils.print_changes(cve2commits, updates)


# In[15]:


with open('cve2commits-thunderbird.json', 'w') as fp:
    json.dump(cve2commits, fp)


# In[ ]:




