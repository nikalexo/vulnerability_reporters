from bs4 import BeautifulSoup
import json
import os
import re

path = './../mozilla-security-advisories/en-US/security/advisories/'

# get all files
files = []
# r=root, d=directories, f = files
for r, d, f in os.walk(path):
    for file in f:
        if 'index.html' in file:
            files.append(os.path.join(r, file))

# create cve to bug mappings for all files
cve2bugs = dict()

for file in files:
    try:
        with open(file) as f:
            temp = f.read()
        soup = BeautifulSoup(temp,"html.parser")

        cve_refs = soup.findAll('h4', id=re.compile('^CVE-'))
        references = soup.findAll('h5',text='References')
        #print(cve_refs)
        #print(references)

        for i in range(0, len(cve_refs)):
            cve = cve_refs[i].get('id')
            refs = references[i].findNext('ul')
            refs = refs.findAll('li')              

            if cve[0:4] == "CVE-":
                for r in refs:
                    r = r.text.replace("\n", "")
                    if r[0:4] == "Bug ":
                        r = r.split(" ")
                        for i in range(1, len(r)):
                            try:
                                bug = int(r[i].strip(","))
                                if not cve in cve2bugs.keys():
                                    cve2bugs[cve] = []
                                if not str(bug) in cve2bugs[cve]:
                                    cve2bugs[cve].append(str(bug))                                    
                                    print(cve, bug, cve2bugs[cve])
                            except:
                                print("Can not convert reference to bug id:", r)
    except AttributeError:
        print('ERROR')

with open('cve2bugs-mozilla_sec_adv.json', 'w') as fp:
    json.dump(cve2bugs, fp)