#!/usr/bin/env python
# coding: utf-8

# In[1]:


import json
import sys
import os
import re
from git import Repo
from pymongo import MongoClient
import xml.etree.ElementTree as ET
import utils


# In[2]:


# insert at 1, 0 is the script path (or '' in REPL)
sys.path.insert(1, '../../../cve-search/')

import lib.DatabaseLayer as db


# In[3]:


root = ET.parse("./../../config.xml")

DB = root.find("mongodb").find("db").text
COLLECTION_1 = root.find("projects").find('.//product[@name=\'mozilla-core\']').find("collection").text
COLLECTION_2 = root.find("projects").find('.//product[@name=\'firefox\']').find("collection").text

URLS = root.find("projects").find('.//product[@name=\'firefox\']').find("bugs").find("base_url").text.split("\n")
REG_EXPRS = root.find("projects").find('.//product[@name=\'firefox\']').find("reg_exprs_bug_commit").text.split("\n")

REPO = "../../../gecko-dev"


# In[4]:


# load bug collections of projects from mongodb database
client = MongoClient()
db1 = client[DB]

collection_1 = db1[COLLECTION_1]
collection_2 = db1[COLLECTION_2]

bug_1 = collection_1.find_one()
bug_2 = collection_2.find_one()

if bug_1 != None:
    print("Example bug core:", bug_1['id'])
else:
    sys.exit("No bugs in database collection for component core!")
if bug_2 != None:
    print("Example bug firefox:", bug_2['id'])
else:
    sys.exit("No bugs in database collection for firefox!")


# In[5]:


# load all cves which are relevant for the project
with open("./../Project_2_CVE/project2cves.json") as jf:
    project2cves = json.load(jf)
    cves = project2cves["firefox"]
print("Number of found cves in cve-search:", len(cves))


# In[6]:


db_cves = client["cvedb"]
coll_cves = db_cves.cves
cve2bugs = dict()
cve_list = []
for cve in cves:
    cve2bugs[cve] = []
    full_cve = coll_cves.find_one({'id':cve})
    if full_cve != None:
        cve_list.append(full_cve)
print("Number of found cves in cve-search:", len(cve_list))


# In[7]:


# 1. Extract bug-ids from cve references
print("Extract bug-ids from cve references...")
utils.get_bugs_from_refs(URLS, cve_list, cve2bugs)


# In[8]:


utils.print_changes(cve2bugs, None)


# In[9]:


# 2.1. Extract CVE id from available fields of bugs in database (e.g. description)
print("Extract CVE-id from available fields of core bugs in database (e.g. description)...")
updates = utils.get_cves_from_database_fields(collection_1, cve2bugs)


# In[10]:


utils.print_changes(cve2bugs, updates)


# In[11]:


# 2.2. Extract CVE id from available fields of bugs in database (e.g. description)
print("Extract CVE-id from available fields of firefox bugs in database (e.g. description)...")
updates = utils.get_cves_from_database_fields(collection_2, cve2bugs)


# In[12]:


utils.print_changes(cve2bugs, updates)


# In[14]:


# 3. Check commit messages in gecko-dev repo
print("Check commit messages in gecko-dev repo for cves and bugs...")
repo = Repo(REPO)
commits = list(repo.iter_commits('master', max_count=1000000))

updates = 0
for expr in REG_EXPRS:
    updates += utils.extract_bugs_commits(cve2bugs, commits, expr)


# In[15]:


utils.print_changes(cve2bugs, updates)


# In[18]:


# 4.1. Check mozilla security advisories 
print("Check mozilla security advisories for additional core bugs...")
with open('cve2bugs-mozilla_sec_adv.json') as jf:
    data = json.load(jf)
    
updates = utils.extract_from_third_source(cve2bugs, data, collection_1)


# In[19]:


utils.print_changes(cve2bugs, updates)


# In[20]:


# 4.2. check mozilla security advisories 
print("Check mozilla security advisories for additional firefox bugs...")
with open('cve2bugs-mozilla_sec_adv.json') as jf:
    data = json.load(jf)
    
updates = utils.extract_from_third_source(cve2bugs, data, collection_2)


# In[22]:


utils.print_changes(cve2bugs, updates)


# In[23]:


# print cves with no bug
# print("CVEs with no found bug:")
# utils.print_cves_with_no_bug(cve2bugs)


# In[24]:


client.close()


# In[25]:


with open('cve2bugs-core-firefox.json', 'w') as fp:
    json.dump(cve2bugs, fp)


# In[ ]:




